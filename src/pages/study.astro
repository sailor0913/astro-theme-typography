---
export const prerender = false

import { Client } from '@notionhq/client'
import type { PageObjectResponse } from '@notionhq/client/build/src/api-endpoints'
import LayoutDefault from '../layouts/LayoutDefault.astro'
import AchievementBadge from '../react-components/AchievementBadge.jsx'
import ActivityTimeline from '../react-components/ActivityTimeline.jsx'
import ProgressCircle from '../react-components/ProgressCircle.jsx'

// åˆå§‹åŒ– Notion å®¢æˆ·ç«¯
const notion = new Client({ auth: import.meta.env.NOTION_API_KEY })

// æ•°æ®åº“ ID
const databaseReadProcessId = '4d353eb81c364cfcb615b72238630e37'
const databaseTodayActivityId = '10769034c78f80efbeeaffc6c1dc16d6'
const databaseAchievementsId = '472d3b0f87b44e6e8cd30a58ce507b90'

// è·å–é˜…è¯»è¿›åº¦æ•°æ®åº“å†…å®¹
const readResponse = await notion.databases.query({
  database_id: databaseReadProcessId,
})

// è·å–ä»Šæ—¥æ´»åŠ¨æ•°æ®åº“å†…å®¹
const today = new Date().toISOString().split('T')[0] // è·å–ä»Šå¤©çš„æ—¥æœŸï¼Œæ ¼å¼ä¸º YYYY-MM-DD
const activityResponse = await notion.databases.query({
  database_id: databaseTodayActivityId,
  filter: {
    property: 'æ´»åŠ¨æ—¥æœŸ',
    date: {
      equals: today,
    },
  },
})

// è·å–æˆå°±æ•°æ®
const achievementsResponse = await notion.databases.query({
  database_id: databaseAchievementsId,
})

// å¤„ç†é˜…è¯»è¿›åº¦æ•°æ®
const books = readResponse.results
  .filter((page): page is PageObjectResponse => 'properties' in page)
  .map((page) => {
    const props = page.properties
    const readPages = props.å·²é˜…è¯»é¡µæ•°.type === 'number' ? (props.å·²é˜…è¯»é¡µæ•°.number ?? 0) : 0
    const totalPages = props.æ€»é¡µæ•°.type === 'number' ? (props.æ€»é¡µæ•°.number ?? 0) : 0
    return {
      title: props.ä¹¦å.type === 'title' ? (props.ä¹¦å.title[0]?.plain_text ?? '') : '',
      readPages,
      totalPages,
      coverImage:
        props.å°é¢å›¾ç‰‡.type === 'files' && props.å°é¢å›¾ç‰‡.files[0]?.type === 'file'
          ? props.å°é¢å›¾ç‰‡.files[0].file.url
          : '',
      progress: totalPages > 0 ? (readPages / totalPages) * 100 : 0,
    }
  })

// å¤„ç†ä»Šæ—¥æ´»åŠ¨æ•°æ®
const activities = activityResponse.results
  .filter((page): page is PageObjectResponse => 'properties' in page)
  .map((page) => {
    const props = page.properties
    return {
      title: props.æ´»åŠ¨åç§°.type === 'title' ? (props.æ´»åŠ¨åç§°.title[0]?.plain_text ?? '') : '',
      description: props.å†…å®¹.type === 'rich_text' ? (props.å†…å®¹.rich_text[0]?.plain_text ?? '') : '',
    }
  })

// å¤„ç†æˆå°±æ•°æ®
const achievements = achievementsResponse.results
  .filter((page): page is PageObjectResponse => 'properties' in page)
  .map((page) => {
    const props = page.properties
    return {
      title: props.åç§°.type === 'title' ? (props.åç§°.title[0]?.plain_text ?? '') : '',
      count: props.æ•°é‡.type === 'number' ? (props.æ•°é‡.number ?? 0) : 0,
      icon: props.å›¾æ ‡.type === 'rich_text' ? (props.å›¾æ ‡.rich_text[0]?.plain_text ?? 'ğŸ†') : 'ğŸ†',
      unit: props.å•ä½.type === 'rich_text' ? (props.å•ä½.rich_text[0]?.plain_text ?? 'ä¸ª') : 'ä¸ª',
    }
  })

const todayFormatted = new Date().toLocaleDateString('zh-CN', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
})
---

<LayoutDefault>
  <main class="container mx-auto px-4 py-8">
    <section class="mb-12">
      <h2 class="text-3xl font-bold mb-6 text-center">æˆ‘çš„é˜…è¯»è¿›åº¦</h2>
      <div class="flex flex-wrap justify-center gap-8">
        {
          books.map((book) => (
            <div class="flex flex-col items-center">
              <ProgressCircle progress={book.progress} label={book.title} imageSrc={book.coverImage} />
              <p class="mt-2 text-center">
                {book.readPages}/{book.totalPages}
              </p>
            </div>
          ))
        }
      </div>
    </section>

    <section class="mb-12">
      <h2 class="text-3xl font-bold mb-6 text-center">ä»Šæ—¥æ´»åŠ¨ï¼ˆ{todayFormatted}ï¼‰</h2>
      <ActivityTimeline activities={activities} />
    </section>

    <section>
      <h2 class="text-3xl font-bold mb-6 text-center">æˆ‘çš„æˆå°±</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
        {
          achievements.map((achievement) => (
            <AchievementBadge
              title={achievement.title}
              icon={achievement.icon}
              count={achievement.count}
              unit={achievement.unit}
            />
          ))
        }
      </div>
    </section>
  </main>
</LayoutDefault>
